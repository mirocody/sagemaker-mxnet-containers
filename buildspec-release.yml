version: 0.2

env:
  variables:
    FRAMEWORK_FULL_VERSION: '1.3.0'
    FRAMEWORK_SHORT_VERSION: '1.3'
    AWS_DEFAULT_REGION: 'us-west-2'
    ECR_REPO: 'sagemaker-mxnet'
    GITHUB_REPO: 'sagemaker-mxnet-container'
    SETUP_CMDS: '#!/bin/bash\npip install --upgrade pip\npip install -U -e .\npip install -U -e .[test]'
    SETUP_FILE: 'setup_cmds.sh'
    GPU_INSTANCE_TYPE: 'ml.p2.xlarge'
    CPU_INSTANCE_TYPE: 'ml.c4.xlarge'


phases:
  pre_build:
    commands:
      - start-dockerd

      - ACCOUNT=$(aws sts get-caller-identity --query 'Account' --output text)
      - BUILD_DIR="docker/$FRAMEWORK_FULL_VERSION/final"

      # fix permissions dropped by CodePipeline
      - chmod +x ./scripts/*.sh

      # keep ssh connection alive when communicating with remote ec2 server during integ test
      # largest connection idle time allowed: 10 seconds * 360 attempts = 60 minutes
      - echo '  ServerAliveInterval 10' >> ~/.ssh/config
      - echo '  ServerAliveCountMax 360' >> ~/.ssh/config

  build:
    commands:
      # prepare the release (update versions, changelog etc.)
      - git-release --prepare

      - tox -e flake8

      # TODO: make sure both Python versions are run
      # run unit tests
      # - tox -e py27,py36 test/unit
      - pytest test/unit

      # Create pip archive (tar_name will be something like: sagemaker_mxnet_container-2.0.tar.gz)
      - python3 setup.py sdist
      - tar_name=$(ls dist)
      - cp dist/$tar_name $BUILD_DIR

      # build images
      - python3 scripts/build-all.py --version $FRAMEWORK_FULL_VERSION --account $ACCOUNT --repo $ECR_REPO

      # push docker images to ECR
      - python3 scripts/publish-all.py --version $FRAMEWORK_FULL_VERSION --account $ACCOUNT --repo $ECR_REPO

      # TODO: make sure both Python versions are run
      # run cpu integration tests
      - tox -e py35 test/integration/local --py-version 3 --processor cpu --framework-version $FRAMEWORK_FULL_VERSION --region $AWS_DEFAULT_REGION --docker-base-name $ECR_REPO

      # launch remote gpu instance
      - prefix='ml.'
      - instance_type=${GPU_INSTANCE_TYPE#"$prefix"}
      - create-key-pair
      - launch-ec2-instance --instance-type $instance_type --ami-name dlami-ubuntu

      # TODO: make sure both Python versions are run
      # run gpu integration tests
      - printf "$SETUP_CMDS" > $SETUP_FILE
      - cmd="tox -e py35 test/integration/local --region $AWS_DEFAULT_REGION --docker-base-name $PREPROD_IMAGE --framework-version $FRAMEWORK_VERSION --processor gpu"
      - remote-test --github-repo $GITHUB_REPO --test-cmd "$cmd" --setup-file $SETUP_FILE

      # TODO: make sure both Python versions are run
      # run cpu sagemaker tests
      - tox -e py35 test/integration/sagemaker --region $AWS_DEFAULT_REGION --docker-base-name $ECR_REPO --aws-id $ACCOUNT --framework-version $FRAMEWORK_FULL_VERSION --instance-type $CPU_INSTANCE_TYPE

      # TODO: make sure both Python versions are run
      # run gpu sagemaker tests
      - tox -e py35 test/integration/sagemaker --region $AWS_DEFAULT_REGION --docker-base-name $ECR_REPO --aws-id $ACCOUNT --framework-version $FRAMEWORK_FULL_VERSION --instance-type $GPU_INSTANCE_TYPE

      # write deployment details to file
      # todo sort out eia versioning
      - |
        echo '[{
          "repository": "sagemaker-mxnet",
          "tags": [{
            "source": "1.3.0-cpu-py2",
            "dest": ["1.3.0-cpu-py2", "1.3-cpu-py2", "1.3.0-cpu-py2-'${CODEBUILD_BUILD_ID#*:}'"]
          },{
            "source": "1.3.0-gpu-py2",
            "dest": ["1.3.0-gpu-py2", "1.3-gpu-py2", "1.3.0-gpu-py2-'${CODEBUILD_BUILD_ID#*:}'"]
          }]
        }, {
          "repository": "sagemaker-tensorflow-serving-eia",
          "tags": [{
            "source": "1.11-cpu",
            "dest": ["1.11.0-cpu", "1.11.1-cpu", "1.11-cpu", "1.11.1-cpu-'${CODEBUILD_BUILD_ID#*:}'"]
          },{
            "source": "1.12-cpu",
            "dest": ["1.12.0-cpu", "1.12-cpu", "1.12.0-cpu-'${CODEBUILD_BUILD_ID#*:}'"]
          }],
          "test": [
            "tox -e py36 -- test/integration/sagemaker/test_ei.py -n 8 --region {region} --registry 520713654638"
          ]
        }]' > deployments.json

      # publish the release to github
      - git-release --publish

    finally:
      # shut down remote gpu instance
      - cleanup-gpu-instances
      - cleanup-key-pairs

artifacts:
  files:
    - deployments.json
name: ARTIFACT_1
